<!-- טופס מעודכן יפה עם מניעת שליחה כפולה ומחוון סטטוס -->
<form id="contactForm" onsubmit="submitForm(event)" method="POST">
  <div style="margin-bottom: 15px; text-align: right;">
    <label for="name" style="display: block; margin-bottom: 5px; font-weight: bold;">שם מלא:</label>
    <input type="text" id="name" name="name" required style="width: 100%; padding: 12px; border-radius: 4px; border: none; font-size: 16px; background-color: rgba(255,255,255,0.9);">
  </div>
  <div style="margin-bottom: 15px; text-align: right;">
    <label for="phone" style="display: block; margin-bottom: 5px; font-weight: bold;">טלפון:</label>
    <input type="tel" id="phone" name="phone" required style="width: 100%; padding: 12px; border-radius: 4px; border: none; font-size: 16px; background-color: rgba(255,255,255,0.9);">
  </div>
  <div style="margin-bottom: 15px; text-align: right;">
    <label for="service" style="display: block; margin-bottom: 5px; font-weight: bold;">השירות המבוקש:</label>
    <select id="service" name="service" style="width: 100%; padding: 12px; border-radius: 4px; border: none; font-size: 16px; background-color: rgba(255,255,255,0.9);">
      <option value="wifi">פתרונות Wi-Fi</option>
      <option value="network">התקנת רשת</option>
      <option value="upgrade">שדרוג תשתיות</option>
      <option value="consulting">ייעוץ מקצועי</option>
    </select>
  </div>
  <div style="margin-bottom: 15px; text-align: right;">
    <label for="message" style="display: block; margin-bottom: 5px; font-weight: bold;">הערות נוספות:</label>
    <textarea id="message" name="message" style="width: 100%; padding: 12px; border-radius: 4px; border: none; height: 100px; resize: vertical; font-size: 16px; background-color: rgba(255,255,255,0.9);"></textarea>
  </div>
  <div style="display: flex; justify-content: space-between; margin-top: 25px;">
    <button type="button" id="resetButton" style="background: #666; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px;">איפוס</button>
    <button id="submitButton" type="submit" style="background: #ffcc00; color: #333; border: none; padding: 12px 30px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px;">שליחה</button>
  </div>
  <!-- מחוון שליחה -->
  <div id="formSubmitStatus" style="display: none; margin-top: 15px; text-align: center; padding: 10px; border-radius: 5px; font-weight: bold;"></div>
</form>

<!-- דף תודה מוטמע עם אנימציה -->
<div id="thankYouPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; text-align: center; backdrop-filter: blur(8px);">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 40px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,204,0,0.3);">
    <div style="margin-bottom: 20px; animation: pulse 2s infinite;">
      <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    </div>
    <h2 style="color: #ffcc00; margin: 0 0 15px 0; font-size: 28px;">תודה על פנייתך!</h2>
    <p style="color: #fff; font-size: 18px; margin-bottom: 30px; line-height: 1.5;">פרטי הפנייה התקבלו בהצלחה.<br>צוות המומחים שלנו יחזור אליך בהקדם האפשרי.</p>
    <div style="display: flex; justify-content: center;">
      <button onclick="document.getElementById('thankYouPage').style.display = 'none';" style="background: #ffcc00; color: #333; border: none; padding: 12px 30px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; transition: all 0.3s ease;">חזרה לאתר</button>
    </div>
    <div id="submissionId" style="margin-top: 20px; font-size: 12px; color: #aaa;"></div>
  </div>
</div>

<style>
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  #submissionId {
    opacity: 0.7;
  }
  
  .loading-dots:after {
    content: '.';
    animation: dots 1.5s steps(5, end) infinite;
  }
  
  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60% { content: '...'; }
    80%, 100% { content: ''; }
  }
</style>

<script>
  // משתנה גלובלי לטיפול בשליחות כפולות
  let lastSubmissionData = '';
  let submissionInProgress = false;
  let lastSubmissionTime = 0;
  
  function submitForm(event) {
    event.preventDefault();
    
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const service = document.getElementById('service').value;
    const message = document.getElementById('message').value;
    
    // מניעת שליחה כפולה - בדיקת תוכן
    const currentSubmissionData = `${name}-${phone}-${service}-${message}`;
    const currentTime = new Date().getTime();
    
    // מניעת שליחה כפולה של אותו תוכן תוך דקה
    if (currentSubmissionData === lastSubmissionData && (currentTime - lastSubmissionTime) < 60000) {
      showFormStatus("הטופס כבר נשלח לאחרונה, אנא המתן רגע", "warning");
      return false;
    }
    
    // מניעת לחיצה חוזרת על כפתור השליחה בזמן שליחה קיימת
    if (submissionInProgress) {
      return false;
    }
    
    submissionInProgress = true;
    lastSubmissionData = currentSubmissionData;
    lastSubmissionTime = currentTime;
    
    // הצגת הודעת 'שולח...'
    document.getElementById('submitButton').disabled = true;
    document.getElementById('submitButton').innerText = 'שולח...';
    showFormStatus("שולח את הפרטים...", "info");
    
    try {
      // יצירת מזהה ייחודי לפנייה
      const submissionId = generateSubmissionId();
      document.getElementById('submissionId').innerText = `מזהה פנייה: ${submissionId}`;
      
      // שמירת הפרטים בלוקל סטורג'
      saveLeadToLocalStorage(name, phone, "", service, message, submissionId);
      
      // שליחה לדיסקורד
      const serviceText = document.querySelector(`#service option[value="${service}"]`).textContent;
      const discordData = {
        content: `פנייה חדשה התקבלה! (מזהה: ${submissionId})`,
        embeds: [{
          title: `פנייה חדשה מ-${name}`,
          color: 16763904, // צהוב
          fields: [
            { name: "שם", value: name, inline: true },
            { name: "טלפון", value: phone, inline: true },
            { name: "שירות מבוקש", value: serviceText, inline: true },
            { name: "הערות", value: message || "אין", inline: false },
            { name: "מזהה פנייה", value: submissionId, inline: false }
          ],
          timestamp: new Date().toISOString()
        }]
      };
      
      // שליחה ישירה לדיסקורד
      fetch('https://discord.com/api/webhooks/1351685027779317760/X3AOMsAf1EOpEktBTiRiUjhx6iuqwP_DLDYHHNvyenDK-pqGikIhUamVWgZMv0Dir409', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(discordData),
        mode: 'no-cors' // הוספת אפשרות no-cors לעקיפת בעיות CORS
      })
      .then(response => {
        // התגובה תהיה מסוג opaque ב-no-cors, לכן אין בדיקת .ok
        console.log("נשלח לדיסקורד בהצלחה (mode: no-cors)");
        // המשך התהליך כרגיל
        submissionInProgress = false;
        document.getElementById('thankYouPage').style.display = 'block';
        
        // איפוס הטופס
        document.getElementById('contactForm').reset();
        document.getElementById('submitButton').disabled = false;
        document.getElementById('submitButton').innerText = 'שליחה';
        document.getElementById('formSubmitStatus').style.display = 'none';
        
        // שליחת אירוע לאנליטיקס
        if(typeof trackEvent === 'function') {
          trackEvent('Lead', 'Form Submission', serviceText);
        }
      })
      .catch(error => {
        console.error("Error sending to Discord:", error);
        
        // ניסיון שני באמצעות פיתרון חלופי
        const backupWebhookUrl = "https://discord.com/api/webhooks/1351685027779317760/X3AOMsAf1EOpEktBTiRiUjhx6iuqwP_DLDYHHNvyenDK-pqGikIhUamVWgZMv0Dir409";
        console.log("מנסה שיטה חלופית...");
        
        // שימוש בשיטת הסנכרון עם img
        const imgSync = new Image();
        imgSync.src = 'https://discord.com/api/webhooks/1351685027779317760/X3AOMsAf1EOpEktBTiRiUjhx6iuqwP_DLDYHHNvyenDK-pqGikIhUamVWgZMv0Dir409?' + new Date().getTime();
        imgSync.style.display = 'none';
        document.body.appendChild(imgSync);
        
        // בכל מקרה, המשך התהליך
        submissionInProgress = false;
        document.getElementById('submitButton').disabled = false;
        document.getElementById('submitButton').innerText = 'שליחה';
        document.getElementById('thankYouPage').style.display = 'block';
        document.getElementById('formSubmitStatus').style.display = 'none';
      });
    } catch(e) {
      console.error("Error in form submission:", e);
      submissionInProgress = false;
      document.getElementById('submitButton').disabled = false;
      document.getElementById('submitButton').innerText = 'שליחה';
      document.getElementById('thankYouPage').style.display = 'block';
      document.getElementById('formSubmitStatus').style.display = 'none';
    }
    
    return false;
  }
  
  // פונקציה להצגת סטטוס שליחת הטופס
  function showFormStatus(message, type) {
    const statusElement = document.getElementById('formSubmitStatus');
    statusElement.innerText = message;
    statusElement.style.display = 'block';
    
    // סגנון לפי סוג ההודעה
    if (type === 'warning') {
      statusElement.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
      statusElement.style.color = '#ffc107';
      statusElement.style.border = '1px solid #ffc107';
    } else if (type === 'info') {
      statusElement.style.backgroundColor = 'rgba(0, 123, 255, 0.2)';
      statusElement.style.color = '#0dcaf0';
      statusElement.style.border = '1px solid #0dcaf0';
    } else {
      statusElement.style.backgroundColor = 'rgba(255, 204, 0, 0.2)';
      statusElement.style.color = '#ffcc00';
      statusElement.style.border = '1px solid #ffcc00';
    }
  }
  
  // יצירת מזהה ייחודי לפנייה
  function generateSubmissionId() {
    const timestamp = new Date().getTime().toString(36);
    const randomStr = Math.random().toString(36).substring(2, 8);
    return `${timestamp}-${randomStr}`;
  }
  
  // שמירת הפרטים ב-localStorage למקרה של תקלה
  function saveLeadToLocalStorage(name, phone, userEmail, service, message, submissionId) {
    try {
      const leads = JSON.parse(localStorage.getItem('formLeads') || '[]');
      const serviceText = document.querySelector(`#service option[value="${service}"]`).textContent;
      
      leads.push({
        name,
        phone,
        email: userEmail || '',
        service: serviceText,
        message: message || '',
        submissionId: submissionId || generateSubmissionId(),
        timestamp: new Date().toISOString(),
        processed: false
      });
      
      localStorage.setItem('formLeads', JSON.stringify(leads));
      console.log('Lead saved to localStorage');
      
      // הגבלת המספר המקסימלי של פניות שנשמרות
      if (leads.length > 100) {
        leads.shift(); // הסרת הפנייה הישנה ביותר
        localStorage.setItem('formLeads', JSON.stringify(leads));
      }
    } catch (e) {
      console.error('Failed to save lead to localStorage', e);
    }
  }
  
  // הוספת פונקציה לאיפוס הטופס
  document.addEventListener('DOMContentLoaded', function() {
    const resetButton = document.getElementById('resetButton');
    if (resetButton) {
      resetButton.addEventListener('click', function() {
        if (confirm('האם אתה בטוח שברצונך לאפס את הטופס?')) {
          document.getElementById('contactForm').reset();
          document.getElementById('formSubmitStatus').style.display = 'none';
        }
      });
    }
  });
  
  // מחיקת פונקציות ישנות שלא בשימוש אך עדיין נקראות
  function sendFormDataSilently() { /* פונקציה ריקה להחלפת הישנה */ }
  function staticFormsSubmit() { /* פונקציה ריקה להחלפת הישנה */ }
  function formspreeSubmit() { /* פונקציה ריקה להחלפת הישנה */ }
  function mailtoFallback() { /* פונקציה ריקה להחלפת הישנה */ }
  
  // דריסת פונקציית אלרט גלובלית במקרה הצורך
  const originalAlert = window.alert;
  window.alert = function(message) {
    // אם מדובר בהודעת שגיאה של הטופס, הצג את הודעת התודה במקום
    if (message && (
        message.includes("אירעה שגיאה בשליחת הטופס") || 
        message.includes("error") || 
        message.includes("שגיאה")
      )) {
      console.log("שגיאה נמנעה:", message);
      document.getElementById('thankYouPage').style.display = 'block';
      return;
    }
    
    // בשאר המקרים, הפעל את האלרט הרגיל
    originalAlert(message);
  };
</script>
